{"version":3,"sources":["../../src/components/flow-viewer/index.jsx"],"names":["React","useEffect","BpmnViewer","_loadBpmnDemo","id","dataForm","container","document","getElementById","innerHTML","viewer","height","diagramXML","xml","importXML","result","warnings","overlays","get","canvas","zoom","add","position","bottom","right","html","addMarker","console","log","message","loadFlowChar","data","jsCanvas","flowXml","historyNodeList","historyNodeId","split","historyTasks","runTimeTasks","item","nodeId","bindOverlays","call","genarateHtml","tasks","content","d","push","assigneeUserName","createdTime","endTime","stateDesc","join","addOverlays","scale","overlayId","bindEvent","remove","undefined","event","listener","elmt","querySelector","FlowViewer","props"],"mappings":"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","sourcesContent":["import React, { useEffect } from \"react\";\nimport BpmnViewer from \"bpmn-js/lib/NavigatedViewer\";\n\nasync function _loadBpmnDemo(id, dataForm) {\n  let container = document.getElementById(id);\n  if (!container) return;\n  container.innerHTML = \"\";\n  let viewer = new BpmnViewer({\n    container: `#${id}`,\n    height: \"500px\",\n  });\n  let diagramXML = dataForm.xml || \"\";\n\n  try {\n    const result = await viewer.importXML(diagramXML);\n    const { warnings } = result;\n\n    // access viewer components\n    let overlays = viewer.get(\"overlays\");\n    let canvas = viewer.get(\"canvas\");\n\n    // zoom to fit full viewport\n    canvas.zoom(\"fit-viewport\");\n\n    // attach an overlay to a node\n    overlays.add(\"SCAN_OK\", \"note\", {\n      position: {\n        bottom: 0,\n        right: 0,\n      },\n      html: '<div class=\"diagram-note\">Mixed up the labels?</div>',\n    });\n\n    // add marker\n    canvas.addMarker(\"SCAN_OK\", \"needs-discussion\");\n  } catch (err) {\n    console.log(err.message, err.warnings);\n  }\n}\n\nexport async function loadFlowChar(id, data) {\n  let jsCanvas = document.getElementById(id);\n  if (!jsCanvas || !data.flowXml) return;\n  jsCanvas.innerHTML = \"\";\n  let viewer = new BpmnViewer({\n    container: `#${id}`,\n    height: \"600px\",\n  });\n  let diagramXML = data.flowXml || \"\";\n\n  try {\n    const result = await viewer.importXML(diagramXML);\n    const { warnings } = result;\n    let overlays = viewer.get(\"overlays\");\n    let canvas = viewer.get(\"canvas\");\n\n    // zoom to fit full viewport\n    canvas.zoom(\"fit-viewport\");\n\n    let historyNodeList = data?.historyNodeId?.split(\",\") || [];\n\n    const { historyTasks = [], runTimeTasks = [] } = data;\n\n    // 历史任务 置灰\n    for (let item of historyTasks) {\n      canvas.addMarker(item.nodeId, \"endHighlight\");\n      bindOverlays.call(\n        overlays,\n        item.nodeId,\n        genarateHtml(historyTasks, item.nodeId)\n      );\n    }\n\n    //当前节点 高亮\n    for (let item of runTimeTasks) {\n      canvas.addMarker(item.nodeId, \"highlight\");\n      bindOverlays.call(\n        overlays,\n        item.nodeId,\n        genarateHtml(runTimeTasks, item.nodeId)\n      );\n    }\n\n    // 驳回节点 标红\n    // let rejectNodeList = data?.rejectNodeId\n    //   ? data?.rejectNodeId.split(\",\")\n    //   : [];\n\n    // for (let i = 0; i < rejectNodeList.length; i++) {\n    //   canvas.addMarker(rejectNodeList[i], \"errorHighlight\");\n    // }\n  } catch (err) {\n    console.log(err.message, err.warnings);\n  }\n}\n\nfunction genarateHtml(tasks, id) {\n  let content = [];\n  for (let d of tasks) {\n    if (d.nodeId === id) {\n      content.push(`<div class=\"note-card\">\n        <p>执行人：${d?.assigneeUserName || \"\"}</p>\n        <p>开始时间：${d?.createdTime || \"\"}</p>\n        <p>结束时间：${d?.endTime || \"\"}</p>\n        <p>意见：${d?.stateDesc || \"\"}</p>\n      </div>`);\n    }\n  }\n  return `<div class=\"diagram-note\">${content.join(\"\")}</div>`;\n}\n\nfunction addOverlays(\n  id,\n  html = `<div class=\"diagram-note\">Mixed up the labels?</div>`\n) {\n  return this.add(id, {\n    position: {\n      bottom: 0,\n      right: 0,\n    },\n    scale: false,\n    html: html,\n  });\n}\n\n// this -> overlays （节省一个参数）\nfunction bindOverlays(id, html) {\n  let overlayId; // 闭包引用 - 鼠标离开时使用\n  bindEvent(id, \"onmouseenter\", () => {\n    overlayId = addOverlays.call(this, id, html);\n  });\n  bindEvent(id, \"onmouseleave\", () => {\n    this.remove(overlayId);\n    overlayId = undefined;\n  });\n}\n\nfunction bindEvent(id, event, listener) {\n  let elmt = document.querySelector(`[data-element-id=${id}]`);\n  elmt[event] = listener;\n}\n\nfunction FlowViewer({ data } = props) {\n  useEffect(() => {\n    // loadBpmnDemo('flow_container', { xml: xmlDemo });\n    // console.log(data)\n    if (data) {\n      loadFlowChar(\"flow_container\", data);\n    }\n\n    return () => {};\n  }, [data]);\n\n  return (\n    <div className=\"flow-viewer\">\n      <div id=\"flow_container\"></div>\n    </div>\n  );\n}\n\nexport default FlowViewer"],"file":"index.js"}