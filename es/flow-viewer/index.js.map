{"version":3,"sources":["../../src/components/flow-viewer/index.jsx"],"names":["React","useEffect","BpmnViewer","_loadBpmnDemo","id","dataForm","container","document","getElementById","innerHTML","viewer","height","diagramXML","xml","importXML","result","warnings","overlays","get","canvas","zoom","add","position","bottom","right","html","addMarker","console","log","message","loadFlowChar","data","jsCanvas","flowXml","historyNodeList","historyNodeId","split","historyTasks","runTimeTasks","item","state","nodeId","bindOverlays","call","genarateHtml","tasks","content","d","push","assigneeUserName","userNames","createdTime","endTime","stateDesc","join","addOverlays","scale","overlayId","bindEvent","remove","undefined","event","listener","elmt","querySelector","FlowViewer","props"],"mappings":"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","sourcesContent":["import React, { useEffect } from \"react\";\r\nimport BpmnViewer from \"bpmn-js/lib/NavigatedViewer\";\r\n\r\nasync function _loadBpmnDemo(id, dataForm) {\r\n  let container = document.getElementById(id);\r\n  if (!container) return;\r\n  container.innerHTML = \"\";\r\n  let viewer = new BpmnViewer({\r\n    container: `#${id}`,\r\n    height: \"500px\",\r\n  });\r\n  let diagramXML = dataForm.xml || \"\";\r\n\r\n  try {\r\n    const result = await viewer.importXML(diagramXML);\r\n    const { warnings } = result;\r\n\r\n    // access viewer components\r\n    let overlays = viewer.get(\"overlays\");\r\n    let canvas = viewer.get(\"canvas\");\r\n\r\n    // zoom to fit full viewport\r\n    canvas.zoom(\"fit-viewport\");\r\n\r\n    // attach an overlay to a node\r\n    overlays.add(\"SCAN_OK\", \"note\", {\r\n      position: {\r\n        bottom: 0,\r\n        right: 0,\r\n      },\r\n      html: '<div class=\"diagram-note\">Mixed up the labels?</div>',\r\n    });\r\n\r\n    // add marker\r\n    canvas.addMarker(\"SCAN_OK\", \"needs-discussion\");\r\n  } catch (err) {\r\n    console.log(err.message, err.warnings);\r\n  }\r\n}\r\n\r\nexport async function loadFlowChar(id, data) {\r\n  let jsCanvas = document.getElementById(id);\r\n  if (!jsCanvas || !data.flowXml) return;\r\n  jsCanvas.innerHTML = \"\";\r\n  let viewer = new BpmnViewer({\r\n    container: `#${id}`,\r\n    height: \"600px\",\r\n  });\r\n  let diagramXML = data.flowXml || \"\";\r\n\r\n  try {\r\n    const result = await viewer.importXML(diagramXML);\r\n    const { warnings } = result;\r\n    let overlays = viewer.get(\"overlays\");\r\n    let canvas = viewer.get(\"canvas\");\r\n\r\n    // zoom to fit full viewport\r\n    canvas.zoom(\"fit-viewport\");\r\n\r\n    let historyNodeList = data?.historyNodeId?.split(\",\") || [];\r\n\r\n    const { historyTasks = [], runTimeTasks = [] } = data;\r\n\r\n    // 历史任务 置灰\r\n    for (let item of historyTasks) {\r\n      if (item.state === 'reject') {\r\n        canvas.addMarker(item.nodeId, \"errorHighlight\");\r\n      } else {\r\n        canvas.addMarker(item.nodeId, \"endHighlight\");\r\n      }\r\n      bindOverlays.call(\r\n        overlays,\r\n        item.nodeId,\r\n        genarateHtml(historyTasks, item.nodeId)\r\n      );\r\n    }\r\n\r\n    //当前节点 高亮\r\n    for (let item of runTimeTasks) {\r\n      canvas.addMarker(item.nodeId, \"highlight\");\r\n      bindOverlays.call(\r\n        overlays,\r\n        item.nodeId,\r\n        genarateHtml(runTimeTasks, item.nodeId)\r\n      );\r\n    }\r\n\r\n    // 驳回节点 标红\r\n    // let rejectNodeList = data?.rejectNodeId\r\n    //   ? data?.rejectNodeId.split(\",\")\r\n    //   : [];\r\n\r\n    // for (let i = 0; i < rejectNodeList.length; i++) {\r\n    //   canvas.addMarker(rejectNodeList[i], \"errorHighlight\");\r\n    // }\r\n  } catch (err) {\r\n    console.log(err.message, err.warnings);\r\n  }\r\n}\r\n\r\nfunction genarateHtml(tasks, id) {\r\n  let content = [];\r\n  for (let d of tasks) {\r\n    if (d.nodeId === id) {\r\n      content.push(`<div class=\"note-card\">\r\n        <p>执行人：${d?.assigneeUserName || d?.userNames || \"\"}</p>\r\n        <p>开始时间：${d?.createdTime || \"\"}</p>\r\n        ${d?.endTime ? `<p>结束时间：${d?.endTime}</p>` : ``}\r\n        ${d?.stateDesc ? `<p>意见：${d?.stateDesc}</p>` : ``}\r\n      </div>`);\r\n    }\r\n  }\r\n  return `<div class=\"diagram-note\">${content.join(\"\")}</div>`;\r\n}\r\n\r\nfunction addOverlays(\r\n  id,\r\n  html = `<div class=\"diagram-note\">Mixed up the labels?</div>`\r\n) {\r\n  return this.add(id, {\r\n    position: {\r\n      bottom: 0,\r\n      right: 0,\r\n    },\r\n    scale: false,\r\n    html: html,\r\n  });\r\n}\r\n\r\n// this -> overlays （节省一个参数）\r\nfunction bindOverlays(id, html) {\r\n  let overlayId; // 闭包引用 - 鼠标离开时使用\r\n  bindEvent(id, \"onmouseenter\", () => {\r\n    overlayId = addOverlays.call(this, id, html);\r\n  });\r\n  bindEvent(id, \"onmouseleave\", () => {\r\n    this.remove(overlayId);\r\n    overlayId = undefined;\r\n  });\r\n}\r\n\r\nfunction bindEvent(id, event, listener) {\r\n  let elmt = document.querySelector(`[data-element-id=${id}]`);\r\n  elmt[event] = listener;\r\n}\r\n\r\nfunction FlowViewer({ data } = props) {\r\n  useEffect(() => {\r\n    // loadBpmnDemo('flow_container', { xml: xmlDemo });\r\n    // console.log(data)\r\n    if (data) {\r\n      loadFlowChar(\"flow_container\", data);\r\n    }\r\n\r\n    return () => {};\r\n  }, [data]);\r\n\r\n  return (\r\n    <div className=\"flow-viewer\">\r\n      <div id=\"flow_container\"></div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default FlowViewer"],"file":"index.js"}